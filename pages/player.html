<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<title>Player</title>
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" type="text/css" href="./src/styles/global.css">
	<link rel="stylesheet" type="text/css" href="./src/styles/player.css">
	<link rel="preconnect" href="https://fonts.gstatic.com">
	<link href="https://fonts.googleapis.com/css2?family=Raleway:wght@600&display=swap" rel="stylesheet">
	<link href="https://fonts.googleapis.com/css2?family=Oxygen&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@700&family=Ubuntu&display=swap" rel="stylesheet">
</head>
<body>
	<div id="whiteoutContainer"></div>

	<!-- custom popup placeholder -->
	<div id="jMovieAlert">
		<div id="jMovieMessage">
			<h2 id="messageTitle"></h2>
			<h3 id="messageBody"></h3>
			<button id="messageClose" class="jMovieButton" onclick="closeAlert()">Close</button>
		</div>
	</div>

	<!-- tool buttons --> 
	<button id="infoButton" class="jMovieButton" onclick="openHelp()">?</button>
	<button id="exitButton" class="jMovieButton" onclick="window.jm.closeApp()">Exit</button>
	<button id="homeButton" class="jMovieButton" onclick="location.href='index.html'">Home</button>

	<div id="header" class="player">
		<h1><b style="color: var(--accent);">j</b>movie</h1>
		<form action="search.html" method="GET" id="searchForm">
			<input id="searchBar" class="jMovieInput player" type="text" name="q" placeholder="">
		</form>
	</div>
	<div id="playerContainer">
		<div id="frameContainer">
			<iframe id="player" src=""
	            width="530px"
    	        height="350px"
        	    style="z-index: 1;"
				allowfullscreen>
			</iframe>
		</div>
		<div>
			<h1 id="nowPlaying">Now Playing: </h1>
			<h2>Player Controls:<span id="playerKbs"></span></h2>
			<div id="playerControls">
				<span style="display: inline-flex">
					<h3>Source:</h3>
					<select id="embedSrc" class="jMovieInput" onchange="loadFrameSource()"></select>
				</span>
				<span style="display: inline-flex">
					<h3>Web Filter:</h3>
					<select id="filter" class="jMovieInput" onchange="changeFilterStrength()">
						<option value="off">Off</option>
						<option value="on">On</option>
					</select>
				</span>
			</div>
			<div id="showInputs">
				<span>
					<h3>Season:</h3>
					<h3>Episode:</h3>
				</span>
				<span>
					<input type="text" id="seasonInput" class="jMovieInput" value="1"><br>
					<input type="text" id="episodeInput" class="jMovieInput" value="1">
				</span>
				<button class="jMovieInput" id="playBtn">Play!</button>
			</div>
		</div>
	</div>
	<div id="recommendedContainer">
		<h2 id="similarTo">Similar to <span id="titleName"></span></h2>
		<div id="recommendedTitles"></div>
	</div>
	<script type="text/javascript" src="./src/scripts/helper.js"></script>
	<script>
		// get data from title and update latest watched
		const urlParams = new URLSearchParams(window.location.search);
		let title = urlParams.get("title"); 
		let isShow = urlParams.get("isShow"); 
		let poster = urlParams.get("poster"); 
		let id = urlParams.get("id");

		document.addEventListener("DOMContentLoaded", () => {
			window.jm.clearLogs();

			document.getElementById("searchBar").value = title;
			document.getElementById("nowPlaying").innerHTML += `<i>${title}</i>`;
			document.getElementById("titleName").innerHTML += `<i>${title}</i>`;
			
			generateSearchPlaceholder();

			// load the embed sources from the backend 
			getEmbedList(isShow);
			
			// add title to recently viewed 
			addHistory(id, isShow, title, poster);
			
			document.getElementById("playBtn").addEventListener("click", () => {				

				// load the embed sources from the backend 
				getEmbedList(isShow);

				loadFrameSource();
			});

			// hide the season/episode inputs if it is a movie
			if (isShow == "false")
				document.getElementById("showInputs").style.visibility = "hidden";

			// get config from file system:
			const initConfig = window.jm.fetchConfig().then(config => {
				userConfig = JSON.parse(config);

				document.getElementById("filter").value = userConfig.filterStrength;

				const kbs = userConfig["keybindings"];

				const keys  = Object.values(kbs);
				
				window.addEventListener('keydown', (event) => {
					if (!keys.includes(event.key)) return; // only activate for shortcuts
					
					const typing = (document.activeElement == document.getElementById("searchBar")) 
					if (typing) return; // don't activate when typing in search bar
					
					event.preventDefault();
					switch (event.key) { // allowed bindings for home page
						case keys[0]: // help
							openHelp();
							break;
						case keys[1]: // enter fs
							enterFullScreen();
							break;
						case keys[2]: // exit fs or alert if it is there
							exitFullScreen();
							closeAlert();
							break;
						case keys[3]: // search
							focusSearchBar();
							break;
						case keys[4]: // return home
							location.href = "index.html";
							break;
						case keys[5]: // exit app
							window.jm.closeApp();
							break;
						case keys[6]: // open logs
							openLogs();
							break;
						default:
							break;
					}
				});

				// update DOM with kbs
				document.getElementById("playerKbs").innerHTML +=
					`<small style="font-size:'10px';margin-left:10px;">
						Enter FS: ${keys[1]} / Exit FS: ${keys[2]}</small>`;

				// update CSS variables 
				const theme = userConfig["theme"];

				const root = document.documentElement;
				root.style.setProperty('--accent', theme["accent"]);
				root.style.setProperty('--text', theme["text"]);
				root.style.setProperty('--bg', theme["bg"]);
				root.style.setProperty('--bg2', theme["bg2"]);
			})
			.catch(err => {
				openAlert("Config Error",
					"Unable to load configuration settings: " + err
				);
				fadeLoader(250);
				console.error(err);
			});

			const tmdbSearch = window.jm.tmdbSearch(title).then(data => {
				if (data.includes("[JM ERROR]")) {
					openAlert("Search Error", 
						"Unable to load search results: \n" + data
					);
					return;
				}

				const resultContainer = document.getElementById("recommendedTitles");

				// simple relevance search 
				data.sort((a, b) => {
				try {return levenshtein(q, a["title"])-levenshtein(q, b["title"])}
				catch {return 0;}});
				
				// place sorted data onto DOM
				data.forEach(res => {
					try {
						// edge case handling
						if (res["title"] == undefined ||
						res["id"] == undefined ||
						res["title"] == title) // hide the same show for the search 
						{ return; }
						
						if (res["poster"] == undefined) {
							res["poster"] = "./src/defaultPoster.png";
						}
						
						if (res["isShow"]) {
							resultContainer.innerHTML += 
							`
							<div class="movie">
								<img style="margin-bottom: 20px;" class="poster" src="` + res["poster"] + `" width="150px" height="225px"><br>
								<a class="movieTitle" href="player.html?id=` + res["id"] + `&isShow=` + res["isShow"] + `&title=` + res["title"] + `&poster=` + res["poster"] + `"><i>` + res["title"] + `</i></a>
								<br><svg style="margin-top:20px;" id='TV_Show_24' width='24' height='24' viewBox='0 0 24 24' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'><rect width='24' height='24' stroke='none' fill='#000000' opacity='0'/><g transform="matrix(0.83 0 0 0.83 12 12)" ><path style="stroke: none; stroke-width: 1; stroke-dasharray: none; stroke-linecap: butt; stroke-dashoffset: 0; stroke-linejoin: miter; stroke-miterlimit: 4; fill: rgb(237, 237, 237); fill-rule: nonzero; opacity: 1;" transform=" translate(-15, -16)" d="M 5 6 C 3.895 6 3 6.895 3 8 L 3 20 C 3 21.105 3.895 22 5 22 L 25 22 C 26.105 22 27 21.105 27 20 L 27 8 C 27 6.895 26.105 6 25 6 L 5 6 z M 13 10 C 13.204 10 13.383016 10.076641 13.541016 10.181641 L 18.546875 13.185547 C 18.813875 13.365547 19 13.654 19 14 C 19 14.346 18.813875 14.634453 18.546875 14.814453 L 13.541016 17.818359 C 13.383016 17.923359 13.204 18 13 18 C 12.448 18 12 17.552 12 17 L 12 11 C 12 10.448 12.448 10 13 10 z M 10 24 C 9.63936408342243 23.994899710454515 9.303918635428394 24.184375296169332 9.122112278513482 24.49587284971433 C 8.940305921598572 24.80737040325933 8.940305921598572 25.192629596740673 9.122112278513484 25.50412715028567 C 9.303918635428394 25.815624703830668 9.639364083422432 26.005100289545485 10 26 L 20 26 C 20.360635916577568 26.005100289545485 20.696081364571608 25.815624703830668 20.877887721486516 25.50412715028567 C 21.059694078401428 25.19262959674067 21.059694078401428 24.80737040325933 20.877887721486516 24.49587284971433 C 20.696081364571608 24.184375296169332 20.360635916577568 23.994899710454515 20 24 L 10 24 z" stroke-linecap="round" /></g></svg>
								</div>						
								`;
							}
						else {
							resultContainer.innerHTML += 
							`
							<div class="movie">
								<img style="margin-bottom: 20px;" class="poster" src="` + res["poster"] + `" width="150px" height="225px"><br>
								<a class="movieTitle" href="player.html?id=` + res["id"] + `&isShow=` + res["isShow"] + `&title=` + res["title"] + `&poster=` + res["poster"] + `"><i>` + res["title"] + `</i></a>
								<br><svg style='margin-top:20px;' id='Movie_Projector_24' width='24' height='24' viewBox='0 0 24 24' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'><rect width='24' height='24' stroke='none' fill='#000000' opacity='0'/><g transform="matrix(0.77 0 0 0.77 12 12)" ><path style="stroke: none; stroke-width: 1; stroke-dasharray: none; stroke-linecap: butt; stroke-dashoffset: 0; stroke-linejoin: miter; stroke-miterlimit: 4; fill: rgb(237, 237, 237); fill-rule: nonzero; opacity: 1;" transform=" translate(-12.5, -13)" d="M 14 0 C 11.25 0 9 2.25 9 5 C 9 7.75 11.25 10 14 10 C 16.75 10 19 7.75 19 5 C 19 2.25 16.75 0 14 0 Z M 14 10 L 5 10 C 3.898438 10 3 10.898438 3 12 L 3 20 C 3 21.101563 3.898438 22 5 22 L 7.40625 22 L 5 26 L 7 26 L 10 22.25 L 13 26 L 15 26 L 12.59375 22 L 16 22 C 17.101563 22 18 21.101563 18 20 L 18 12 C 18 10.898438 17.101563 10 16 10 Z M 5 10 C 7.199219 10 9 8.199219 9 6 C 9 3.800781 7.199219 2 5 2 C 2.800781 2 1 3.800781 1 6 C 1 8.199219 2.800781 10 5 10 Z M 14 2 C 15.667969 2 17 3.332031 17 5 C 17 6.667969 15.667969 8 14 8 C 12.332031 8 11 6.667969 11 5 C 11 3.332031 12.332031 2 14 2 Z M 5 4 C 6.117188 4 7 4.882813 7 6 C 7 7.117188 6.117188 8 5 8 C 3.882813 8 3 7.117188 3 6 C 3 4.882813 3.882813 4 5 4 Z M 24 10 L 19 13 L 19 19 L 24 22 Z" stroke-linecap="round" /></g></svg>
								</div>						
								`;
							}
						} catch (err) {
							openAlert("Error",
							"Unable to display shows: " + err
							);
						}
					});
					
				fadeLoader(250);			
				
			})
			.catch(err => {
				fadeLoader(250);
				openAlert("Error",
					"Unable to show recommended titles: " + err
				);
			});
		});
				
		// Helper functions:
		
		// load list of embed sources from file system and parse their tmdb
		async function getEmbedList(isShow) {
			const urls = await window.jm.getEmbedURLs(isShow);
			const dropdown = document.getElementById('embedSrc');
			dropdown.innerHTML = "";

			urls.forEach(item => {
				const title = item.split(",")[0];
				let url = item.split(",")[1];

				// URL query replacement 
				url = url.replace("<TMDB>", id);

				if (isShow == "true") {
					e = document.getElementById("episodeInput").value;
					s = document.getElementById("seasonInput").value;
					url = url.replace("<E>", e);
					url = url.replace("<S>", s);
				}

				// append every option to dropdown menu
				const option = document.createElement('option');
				option.textContent = title;
				option.value = url;

				dropdown.appendChild(option);
				loadFrameSource();
			});
		}

		// get value from dropdown update filter level on backend
		async function changeFilterStrength() {
			strength = document.getElementById("filter").value;

			window.jm.addLog("[JMovie Filter] Updated strength to: " + strength);

			// call IPC function
			const status = await window.jm.updateFilter(strength);
			if (status != "OK")
				openAlert("Filter Error",
					`Unable to change the strength of the web filter: ${status}`);
			else
				openAlert("Filter Changed",
				`Web filter is now ${strength}`);
		}

		// update iframe source from dropdown menu value
		function loadFrameSource() {
			document.getElementById("player").src = document.getElementById("embedSrc").value;
		}

		function enterFullScreen() {
			const playerIframe = document.getElementById('player');
			if (playerIframe.requestFullscreen) {
				playerIframe.requestFullscreen();
			} else if (playerIframe.mozRequestFullScreen) {
				playerIframe.mozRequestFullScreen();
			} else if (playerIframe.webkitRequestFullscreen) {
				playerIframe.webkitRequestFullscreen();
			}
		}

		function exitFullScreen() {
			if (document.exitFullscreen) {
				document.exitFullscreen();
			} else if (document.mozCancelFullScreen) {
				document.mozCancelFullScreen();
			} else if (document.webkitExitFullscreen) {
				document.webkitExitFullscreen();
			}
		}

		function openHelp() {
			const keys  = Object.values(userConfig["keybindings"]);
			messageTitle = "Player Help";
			messageBody = `
				Player Unresponsive? Click around until it works! You are
				protected from opening all ads always- even when the filter is off.
				<br>(See README in Settings)<br>
				<br>Try changing the source if the video keeps spinning.
				<br>Tip: Use Tab & Space/Enter if players are blocking your mouse input.
				<br><br>
				Return home: ${keys[4]}<br>
				Quick search: ${keys[3]}<br>
				Open logs: ${keys[6]}<br>
				See Settings for more shortcuts.
			`;
			openAlert(messageTitle, messageBody);
		}

		// add this title to the most recently viewed 
		function addHistory(id, isShow, title, poster) {
			newView = [title, poster, isShow, id];

			viewed = localStorage.getItem("viewed");
			
			if (viewed == undefined) // begin history 				
				localStorage.setItem("viewed", JSON.stringify([newView]));
			else { // get history and check if we have seen it
				his = JSON.parse(viewed);
				his.forEach(item => { // move seen to front of list
					if (item[2] == newView[2] && item[3] == newView[3])
						his.splice(his.indexOf(item), 1);
				});

				// make room at front for new entry
				if (his.length == 12) {
					his.reverse();
					his.pop();
					his.reverse();
				}
				
				his.push(newView);
				localStorage.setItem("viewed", JSON.stringify(his));
			}
		}

	</script>
</body>
</html>